#!/bin/bash

# A script to create a P4 client for use in WSL and Windows.

# --- Configuration ---
P4USER="squint1"
P4PORT="ssl:35.176.29.207:1666"
HOSTNAME=$(hostname)
ROOT_BASE="D:\\Stage\\"

# --- Globals ---
# These will be set by argument parsing
user=""
hostname=""
p4user=""
p4port=""
p4stream=""
p4client=""
p4passwd=""
root_base=""
client_root_win=""
client_root_wsl=""

# --- Functions ---

show_help() {
  echo ""
  echo "Usage: $0 -s <stream> [options]"
  echo ""
  echo "Required:"
  echo "  -s <stream>  Stream association for client (e.g., //depot/main)."
  echo ""
  echo "Optional:"
  echo "  -p <p4user>   P4USER, default:'$P4USER'."
  echo "  -u <user>     System user, default:'$(whoami)'."
  echo "  -d <p4port>   P4PORT, default:'$P4PORT'."
  echo "  -n <hostname> System hostname, default:'$HOSTNAME'."
  echo "  -r <root>     Client base directory for root, default:'$ROOT_BASE'."
  echo "  -h            Show this help message."
  echo ""
}

parse_arguments() {
  # Set defaults
  user="$(whoami)"
  p4user="$P4USER"
  p4port="$P4PORT"
  hostname="$HOSTNAME"
  root_base="$ROOT_BASE"

  while getopts "p:u:d:n:s:r:h" opt; do
    case $opt in
    u) user="$OPTARG" ;;
    n) hostname="$OPTARG" ;;
    p) p4user="$OPTARG" ;;
    d) p4port="$OPTARG" ;;
    s) p4stream="$OPTARG" ;;
    r) root_base="$OPTARG" ;;
    h) 
      show_help
      exit 0
      ;; 
    \?) 
      echo "Invalid option: -$OPTARG" >&2
      show_help
      exit 1
      ;; 
    esac
  done
}

validate_arguments() {
  if [ -z "$p4stream" ]; then
    echo "Error: missing required arguments." >&2
    show_help
    exit 1
  fi
}

generate_client_details() {
  # Sanitize stream name for use in client name
  local stream_sanitized
  stream_sanitized=$(basename "$p4stream")

  # Construct client name
  p4client="${p4user}_${user}_${hostname}_${stream_sanitized}"

  # Define client root paths
  # Note: P4 requires backslashes for Windows paths in the client spec.
  client_root_win="${root_base%\\}\\\\\${p4client}"
  client_root_wsl=$(wslpath -u "$client_root_win")
}

create_workspace_files() {
  # Create client root directory
  mkdir -p "$client_root_wsl"
  if [ $? -ne 0 ]; then
    echo "Error: Could not create directory '$client_root_wsl'." >&2
    exit 1
  fi

  # Create .p4config
  local p4config="$client_root_wsl/.p4config"
  echo "P4CLIENT=$p4client" >"$p4config"
  echo "P4USER=$p4user" >>"$p4config"
  echo "P4PORT=$p4port" >>"$p4config"

  # Create .p4ignore
  local p4ignore="$client_root_wsl/p4ignore"
  echo ".p4config" >"$p4ignore"
}

display_summary() {
  echo ""
  echo "Client:   $p4client"
  echo "Owner:    $p4user"
  echo "Stream:   $p4stream"
  echo "Root:     $client_root_win"
  echo "AltRoot:  $client_root_wsl"
  echo ""
}

ensure_login() {
    # 1. Pre-flight check for trust
    local info_output
    info_output=$(P4PORT="$p4port" p4 info 2>&1)
    if echo "$info_output" | grep -q "can't be established"; then
        echo "Perforce server at '$p4port' is not trusted."
        read -p "Do you want to trust this server? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            if ! P4PORT="$p4port" p4 trust -y; then
                echo "Failed to establish trust. Please check your configuration." >&2
                exit 1
            fi
            echo "Trust established."
        else
            echo "Aborting without trusting server." >&2
            exit 1
        fi
    fi

    # 2. Check if already logged in
    if P4PORT="$p4port" P4USER="$p4user" p4 login -s >/dev/null 2>&1; then
        echo "Already logged in to Perforce."
        return
    fi

    # 3. Attempt interactive login
    echo "Perforce login required for user '$p4user' on host '$p4port'."
    if P4PORT="$p4port" P4USER="$p4user" p4 login; then
        echo "Login successful."
        return
    fi

    # 4. If login fails, figure out why and exit if it's a permanent error
    local error_check
    error_check=$(P4PORT="$p4port" P4USER="$p4user" p4 login -s 2>&1)

    if echo "$error_check" | grep -q "enabled by 'p4 protect'"; then
        echo "Error: Perforce server access denied for user '$p4user'." >&2
        echo "Please contact your Perforce administrator to enable access via 'p4 protect'." >&2
        exit 1
    fi

    echo "Login was unsuccessful. Aborting." >&2
    exit 1
}

create_p4_client() {
  P4PORT="$p4port" P4USER="$p4user" p4 client -i <<EOF
Client: $p4client
Owner: $p4user
Host:
Description:
 Created by p4_client.sh on $(date)
Root: ${client_root_win}
AltRoots:
 ${client_root_wsl}
Options:    clobber rmdir
SubmitOptions:  revertunchanged
Stream: $p4stream
EOF

  if [ $? -eq 0 ]; then
    echo ""
    echo "Success: created client '$p4client'."
  else
    echo ""
    echo "Error: failed to create client." >&2
    exit 1
  fi
}

# --- Main Logic ---
main() {
  parse_arguments "$@"
  validate_arguments
  ensure_login
  generate_client_details
  create_workspace_files
  display_summary
  create_p4_client
}

main "$@"

exit 0
